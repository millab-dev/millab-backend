name: Deploy Backend to Kubernetes via pendeploy-simple

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Prepare and Send Deployment Request
        env:
          DEPLOYMENT_CONFIG: ${{ secrets.DEPLOYMENT_CONFIG }}
        run: |
          # Extract repository name without owner
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          # Create dynamic image tag: localhost:5000/reponame:commitid
          DYNAMIC_IMAGE_TAG="localhost:5000/${REPO_NAME}:${{ github.sha }}"
          
          echo "üè∑Ô∏è Dynamic image tag: $DYNAMIC_IMAGE_TAG"
          
          # Parse JSON dan extract semua keys
          echo "üìã Parsing deployment config..."
          
          # Validate JSON format first
          echo "$DEPLOYMENT_CONFIG" | jq . > /dev/null || (echo "‚ùå Invalid JSON format!" && exit 1)
          
          # Extract all keys dari JSON config
          PORT=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.PORT // "8080"')
          ENVIRONMENT=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.ENVIRONMENT // "production"')
          JWT_SECRET=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.JWT_SECRET')
          JWT_ACCESS_EXPIRY=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.JWT_ACCESS_EXPIRY // "1h"')
          JWT_REFRESH_EXPIRY=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.JWT_REFRESH_EXPIRY // "7d"')
          FIREBASE_API_KEY=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_API_KEY')
          FIREBASE_AUTH_DOMAIN=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_AUTH_DOMAIN')
          FIREBASE_PROJECT_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_PROJECT_ID')
          FIREBASE_STORAGE_BUCKET=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_STORAGE_BUCKET')
          FIREBASE_MESSAGING_SENDER_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_MESSAGING_SENDER_ID')
          FIREBASE_APP_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_APP_ID')
          FIREBASE_MEASUREMENT_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_MEASUREMENT_ID')
          FIREBASE_SERVICE_ACCOUNT_TYPE=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_TYPE')
          FIREBASE_SERVICE_ACCOUNT_PROJECT_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_PROJECT_ID')
          FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID')
          FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY')
          FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL')
          FIREBASE_SERVICE_ACCOUNT_CLIENT_ID=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_CLIENT_ID')
          FIREBASE_SERVICE_ACCOUNT_AUTH_URI=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_AUTH_URI')
          FIREBASE_SERVICE_ACCOUNT_TOKEN_URI=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_TOKEN_URI')
          FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_X509_CERT_URL=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_X509_CERT_URL')
          FIREBASE_SERVICE_ACCOUNT_CLIENT_X509_CERT_URL=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_CLIENT_X509_CERT_URL')
          FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN')
          CORS_ORIGIN=$(echo "$DEPLOYMENT_CONFIG" | jq -r '.CORS_ORIGIN')
          
          echo "‚úÖ Successfully parsed deployment config"
          echo "üì° Sending deployment request..."
          
          # Send request langsung dengan curl
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"githubUrl\": \"https://github.com/${{ github.repository }}\",
              \"env\": {
                \"IMAGE_REGISTRY\": \"$DYNAMIC_IMAGE_TAG\",
                \"PORT\": \"$PORT\",
                \"ENVIRONMENT\": \"$ENVIRONMENT\", 
                \"JWT_SECRET\": \"$JWT_SECRET\",
                \"JWT_ACCESS_EXPIRY\": \"$JWT_ACCESS_EXPIRY\",
                \"JWT_REFRESH_EXPIRY\": \"$JWT_REFRESH_EXPIRY\",
                \"FIREBASE_API_KEY\": \"$FIREBASE_API_KEY\",
                \"FIREBASE_AUTH_DOMAIN\": \"$FIREBASE_AUTH_DOMAIN\",
                \"FIREBASE_PROJECT_ID\": \"$FIREBASE_PROJECT_ID\",
                \"FIREBASE_STORAGE_BUCKET\": \"$FIREBASE_STORAGE_BUCKET\",
                \"FIREBASE_MESSAGING_SENDER_ID\": \"$FIREBASE_MESSAGING_SENDER_ID\",
                \"FIREBASE_APP_ID\": \"$FIREBASE_APP_ID\",
                \"FIREBASE_MEASUREMENT_ID\": \"$FIREBASE_MEASUREMENT_ID\",
                \"FIREBASE_SERVICE_ACCOUNT_TYPE\": \"$FIREBASE_SERVICE_ACCOUNT_TYPE\",
                \"FIREBASE_SERVICE_ACCOUNT_PROJECT_ID\": \"$FIREBASE_SERVICE_ACCOUNT_PROJECT_ID\",
                \"FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID\": \"$FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID\",
                \"FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY\": \"$FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY\",
                \"FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL\": \"$FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL\",
                \"FIREBASE_SERVICE_ACCOUNT_CLIENT_ID\": \"$FIREBASE_SERVICE_ACCOUNT_CLIENT_ID\",
                \"FIREBASE_SERVICE_ACCOUNT_AUTH_URI\": \"$FIREBASE_SERVICE_ACCOUNT_AUTH_URI\",
                \"FIREBASE_SERVICE_ACCOUNT_TOKEN_URI\": \"$FIREBASE_SERVICE_ACCOUNT_TOKEN_URI\",
                \"FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_X509_CERT_URL\": \"$FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_X509_CERT_URL\",
                \"FIREBASE_SERVICE_ACCOUNT_CLIENT_X509_CERT_URL\": \"$FIREBASE_SERVICE_ACCOUNT_CLIENT_X509_CERT_URL\",
                \"FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN\": \"$FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN\",
                \"CORS_ORIGIN\": \"$CORS_ORIGIN\"
              }
            }" \
            https://api.millab-kubernetes.isacitra.com/create-deployment
        
      - name: Deployment Summary
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          DYNAMIC_IMAGE_TAG="localhost:5000/${REPO_NAME}:${{ github.sha }}"
          
          echo "üöÄ Backend deployment triggered successfully!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Image: $DYNAMIC_IMAGE_TAG"
          echo "Expected URL: https://api.millabindonesia.com"