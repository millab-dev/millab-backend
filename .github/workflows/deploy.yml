name: Deploy Backend to Kubernetes via pendeploy-simple

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Deployment via pendeploy-simple
        env:
          DEPLOYMENT_TEMPLATE: ${{ secrets.DEPLOYMENT_TEMPLATE }}
        run: |
          # Replace template placeholders with actual GitHub Actions variables
          DEPLOYMENT_CONFIG=$(echo "$DEPLOYMENT_TEMPLATE" | \
            sed "s/GITHUB_REPOSITORY_PLACEHOLDER/${{ github.repository }}/g" | \
            sed "s/GITHUB_SHA_PLACEHOLDER/${{ github.sha }}/g")
          
          echo "ðŸš€ Deploying commit: ${{ github.sha }}"
          echo "ðŸ“¦ Repository: ${{ github.repository }}"
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$DEPLOYMENT_CONFIG" \
            https://api.millab-kubernetes.isacitra.com/create-deployment
        
      - name: Deployment Summary
        run: |
          echo "ðŸš€ Backend deployment triggered successfully!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Image: localhost:5000/millab-backend:${{ github.sha }}"
          echo "Expected URL: https://api.millab.isacitra.com"